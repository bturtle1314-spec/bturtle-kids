<script>
let DATA = null;
let currentDay = null;
let selectedWhich = null;

function toDateOnly(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  return x;
}

async function loadData(){
  // 讀同一個資料夾的 data.json
  const res = await fetch('./data.json', { cache: 'no-store' });
  if(!res.ok) throw new Error('讀取 data.json 失敗：' + res.status);
  DATA = await res.json();

  const start = toDateOnly(DATA.startDate + 'T00:00:00');
  const today = toDateOnly(new Date());

  // Day 計算：startDate 當天 = Day 1
  const diff = Math.floor((today - start) / 86400000) + 1;

  // 找到對應的 day；找不到就用第 1 天
  currentDay = DATA.days.find(d => d.day === diff) || DATA.days[0];

  // 把畫面上的文字換掉（這些 id 你等下要確認存在）
  document.getElementById('day').textContent = `Day ${currentDay.day}`;
  document.getElementById('info').textContent =
    `今天：${today.toISOString().slice(0,10)}（從 ${DATA.startDate} 起算）`;

  document.getElementById('btnA').textContent = currentDay.choiceA.title;
  document.getElementById('btnB').textContent = currentDay.choiceB.title;

  // 清空選擇區
  document.getElementById('pickedTitle').textContent = '—';
  document.getElementById('pickedBody').textContent = '請先點上面的 A 或 B。';
  document.getElementById('reward').style.display = 'none';
  selectedWhich = null;
}

function pick(which){
  selectedWhich = which;
  const item = (which === 'A') ? currentDay.choiceA : currentDay.choiceB;
  document.getElementById('pickedTitle').textContent = item.title;
  document.getElementById('pickedBody').textContent = item.body;
}

function unlock(){
  if(!selectedWhich){
    alert('請先選 A 或 B');
    return;
  }
  document.getElementById('rewardTitle').textContent = currentDay.reward.title;
  document.getElementById('rewardImg').src = currentDay.reward.img;
  document.getElementById('reward').style.display = 'block';
}

window.addEventListener('DOMContentLoaded', () => {
  loadData().catch(err => {
    console.error(err);
    document.getElementById('info').textContent = '載入失敗：請確認 data.json 格式是否正確';
  });
});
</script>
