<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B TURTLE Kidsï½œScreen-to-Sleep Switch</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", sans-serif; margin: 0; background:#0b1220; color:#e9eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    .card { background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10); border-radius: 18px; padding: 18px; }
    h1 { margin: 0 0 6px; font-size: 24px; letter-spacing: .2px; }
    .muted { opacity:.78; font-size: 14px; line-height: 1.6; }
    .row { display:flex; gap: 12px; flex-wrap: wrap; margin-top: 14px; }
    .btn {
      flex: 1 1 320px;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.18);
      color:#e9eefc;
      border-radius: 16px;
      padding: 14px;
      cursor:pointer;
      text-align:left;
      transition: transform .05s ease, background .15s ease;
      min-height: 92px;
    }
    .btn:hover { background: rgba(255,255,255,0.13); }
    .btn:active { transform: scale(0.99); }
    .btn h3 { margin:0 0 8px; font-size: 16px; }
    .btn p { margin:0; opacity:.88; line-height: 1.45; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background: rgba(99,102,241,.20); border:1px solid rgba(99,102,241,.35); font-size: 13px; }
    .reward { margin-top: 14px; display:none; }
    .reward img { width: 100%; max-width: 680px; border-radius: 16px; border:1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); }
    .footer { margin-top: 14px; font-size: 13px; opacity:.78; line-height: 1.6; }
    .error { color: #ffb4b4; opacity: 1; }
    .topbar { display:flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
    .linkbtn {
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.16);
      color:#e9eefc;
      border-radius: 999px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
    }
    .linkbtn:hover { background: rgba(255,255,255,0.11); }
    .hidden { display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div class="pill" id="dayPill">Day -</div>
        <button class="linkbtn hidden" id="resetBtn" title="æŠŠé€™å°è£ç½®é‡æ–°å¾ Day 1 é–‹å§‹">é‡æ–°é–‹å§‹</button>
      </div>

      <h1>Screen-to-Sleep Switch</h1>
      <div class="muted" id="dateText">è¼‰å…¥ä¸­â€¦</div>

      <div class="row" id="choicesRow" style="margin-top:16px;">
        <button class="btn" id="btnA" type="button">
          <h3 id="aTitle">Aï¼š</h3>
          <p id="aBody"></p>
        </button>
        <button class="btn" id="btnB" type="button">
          <h3 id="bTitle">Bï¼š</h3>
          <p id="bBody"></p>
        </button>
      </div>

      <div class="reward" id="rewardBox">
        <div class="pill" style="margin-bottom:10px;" id="rewardTitle">è§£é–çå‹µ</div>
        <div class="muted" style="margin-bottom:10px;">ä½ å·²å®Œæˆä»Šå¤©çš„ã€Œæ”¶æ‰‹æ©Ÿè½‰å ´ã€âœ…</div>
        <img id="rewardImg" alt="reward" />
      </div>

      <div class="footer" id="hint">
        å°æé†’ï¼šå¦‚æœä½ æ›´æ–°äº† data.json ä½†çœ‹ä¸åˆ°è®ŠåŒ–ï¼Œè«‹ç”¨ <b>Ctrl+F5</b>ï¼ˆæ‰‹æ©Ÿå°±ä¸‹æ‹‰é‡æ–°æ•´ç†ï¼‰å¼·åˆ¶åˆ·æ–°ã€‚
      </div>
      <div class="footer error" id="err"></div>
    </div>
  </div>

  <script>
    const errEl = document.getElementById("err");

    function toLocalDateOnly(d) {
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }

    function daysBetween(a, b) {
      const ms = 24 * 60 * 60 * 1000;
      return Math.round((toLocalDateOnly(b) - toLocalDateOnly(a)) / ms);
    }

    function formatYMD(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    async function loadData() {
      // ç›¸å°è·¯å¾‘ï¼šç¢ºä¿ GitHub Pages çš„ /bturtle-kids/ å¯è®€åˆ°åŒè³‡æ–™å¤¾ data.json
      const url = "./data.json?ts=" + Date.now();
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("è®€å– data.json å¤±æ•—ï¼ˆHTTP " + res.status + "ï¼‰ã€‚è«‹ç¢ºèª data.json åœ¨åŒè³‡æ–™å¤¾ï¼Œä¸”å…§å®¹æ˜¯ JSONã€‚");
      return await res.json();
    }

    function getDayNumber(data) {
      const today = new Date();
      const mode = (data.mode || "rolling").toLowerCase();

      if (mode === "personal") {
        // æ¯å°è£ç½®ç¬¬ä¸€æ¬¡æ‰“é–‹å°±å¾ Day1 é–‹å§‹ï¼ˆå®¶é•·ä¸éœ€è¦ç„¡ç—•ï¼‰
        const k = "bturtle_personal_start_ymd";
        let startYMD = localStorage.getItem(k);
        if (!startYMD) {
          startYMD = formatYMD(today);
          localStorage.setItem(k, startYMD);
        }
        const start = new Date(startYMD);
        const diff = daysBetween(start, today);
        return { dayNum: Math.max(1, diff + 1), mode, personalStart: startYMD };
      }

      // rollingï¼šç…§æ—¥æ›†èµ°ï¼ˆä»¥ startDate ç‚º Day1ï¼‰
      const startStr = data.startDate;
      if (!startStr) throw new Error("data.json ç¼ºå°‘ startDateï¼ˆrolling æ¨¡å¼éœ€è¦ï¼‰ã€‚");
      const start = new Date(startStr);
      const diff = daysBetween(start, today);
      return { dayNum: Math.max(1, diff + 1), mode, personalStart: null };
    }

    function doneKey(mode, dayNum) {
      return `bturtle_done_${mode}_day_${dayNum}`;
    }

    function maxDay(data) {
      const arr = data.days || [];
      let m = 0;
      for (const d of arr) m = Math.max(m, Number(d.day || 0));
      return m;
    }

    function renderFinished(data, info) {
      const md = maxDay(data);
      document.getElementById("dayPill").textContent = "å®Œæˆ ğŸ‰";
      const extra = info.mode === "personal"
        ? `ï¼ˆä½ çš„ Day1 èµ·å§‹æ—¥ï¼š${info.personalStart}ï¼‰`
        : `ï¼ˆèµ·å§‹æ—¥ï¼š${data.startDate}ï¼‰`;
      document.getElementById("dateText").textContent =
        `ä½ å·²å®Œæˆ ${md} å¤©æŒ‘æˆ° ${extra}`;

      document.getElementById("choicesRow").classList.add("hidden");
      document.getElementById("rewardBox").classList.remove("hidden");
      document.getElementById("rewardBox").style.display = "block";
      document.getElementById("rewardTitle").textContent = "âœ… ç¬¬ä¸€é€±å®Œæˆå¾½ç« ";
      document.getElementById("rewardImg").src = "https://placehold.co/800x450?text=Week+Complete";
    }

    function renderDay(data) {
      const info = getDayNumber(data);
      const todayText = new Date().toLocaleDateString("zh-Hant");
      const md = maxDay(data);

      // é¡¯ç¤º Reset æŒ‰éˆ•ï¼špersonal æ¨¡å¼æ‰éœ€è¦
      const resetBtn = document.getElementById("resetBtn");
      if (info.mode === "personal") {
        resetBtn.classList.remove("hidden");
        resetBtn.onclick = () => {
          const ok = confirm("ç¢ºå®šè¦åœ¨é€™å°è£ç½®é‡æ–°å¾ Day 1 é–‹å§‹å—ï¼Ÿï¼ˆæœƒæ¸…é™¤æœ¬æ©Ÿçš„å®Œæˆç´€éŒ„ï¼‰");
          if (!ok) return;

          // æ¸…é™¤ personal start + æ‰€æœ‰å·²å®Œæˆ
          localStorage.removeItem("bturtle_personal_start_ymd");
          for (let i = 1; i <= 365; i++) {
            localStorage.removeItem(doneKey("personal", i));
          }
          location.reload();
        };
      } else {
        resetBtn.classList.add("hidden");
      }

      // è¶…éæœ€å¤§å¤©æ•¸ï¼šé¡¯ç¤ºå®Œæˆé 
      if (info.dayNum > md) {
        renderFinished(data, info);
        return;
      }

      document.getElementById("dayPill").textContent = "Day " + info.dayNum;

      if (info.mode === "personal") {
        document.getElementById("dateText").textContent =
          `æ¨¡å¼ï¼šæ¯å€‹å®¶åº­è‡ªå·±å¾ Day1 é–‹å§‹ï½œä½ çš„ Day1ï¼š${info.personalStart}ï½œä»Šå¤©ï¼š${todayText}`;
      } else {
        document.getElementById("dateText").textContent =
          `æ¨¡å¼ï¼šç…§æ—¥æ›†èµ°ï½œStartDateï¼š${data.startDate}ï½œä»Šå¤©ï¼š${todayText}`;
      }

      const dayObj = (data.days || []).find(d => Number(d.day) === Number(info.dayNum));
      if (!dayObj) {
        document.getElementById("choicesRow").classList.add("hidden");
        document.getElementById("rewardBox").classList.add("hidden");
        errEl.textContent = "æ‰¾ä¸åˆ° Day " + info.dayNum + " çš„è³‡æ–™ã€‚è«‹ç¢ºèª data.json çš„ days å…§æœ‰å°æ‡‰ dayã€‚";
        return;
      }

      const dk = doneKey(info.mode, info.dayNum);
      const done = localStorage.getItem(dk);

      if (done === "A" || done === "B") {
        showReward(dayObj, done);
        return;
      }

      document.getElementById("choicesRow").classList.remove("hidden");
      document.getElementById("rewardBox").classList.add("hidden");
      document.getElementById("rewardBox").style.display = "none";

      document.getElementById("aTitle").textContent = dayObj.choiceA?.title || "A";
      document.getElementById("aBody").textContent  = dayObj.choiceA?.body  || "";

      document.getElementById("bTitle").textContent = dayObj.choiceB?.title || "B";
      document.getElementById("bBody").textContent  = dayObj.choiceB?.body  || "";

      document.getElementById("btnA").onclick = () => {
        localStorage.setItem(dk, "A");
        showReward(dayObj, "A");
      };
      document.getElementById("btnB").onclick = () => {
        localStorage.setItem(dk, "B");
        showReward(dayObj, "B");
      };
    }

    function showReward(dayObj, choice) {
      document.getElementById("choicesRow").classList.add("hidden");
      const reward = dayObj.reward || {};
      document.getElementById("rewardTitle").textContent = reward.title ? reward.title : ("å·²å®Œæˆï¼ˆé¸äº† " + choice + "ï¼‰");
      document.getElementById("rewardImg").src = reward.img ? reward.img : "https://placehold.co/800x450?text=Reward";
      const rb = document.getElementById("rewardBox");
      rb.classList.remove("hidden");
      rb.style.display = "block";
    }

    (async () => {
      try {
        const data = await loadData();
        renderDay(data);
      } catch (e) {
        errEl.textContent = String(e);
      }
    })();
  </script>
</body>
</html>
